<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="assignment">
	<select id="employeeReportSupervisor" resultClass="adins.ace.taps.bean.assignment.EmployeeReportBean" parameterClass="java.util.Map">
		SELECT * FROM (
			SELECT ROWNUM seqnumb, a.* FROM (
				SELECT to_char(a.assignment_date,'DD-MM-YYYY, HH:MM') AS assignmentDate, 
					a.task_code AS assignmentCode,
					a.assignment_category AS assignmentCategory, 
					e.first_name || ' ' || e.last_name AS fullName,
					to_char(a.created_date,'DD-MM-YYYY, HH:MM') AS createdDate,
					to_char(a.assignment_due_date, 'DD-MM-YYYY') AS assignmentDueDate, 
					a.current_status AS currentStatus
				FROM assignments a 
				LEFT JOIN employees e
				ON LOWER(a.flag)='active' AND a.report_to = 'DOMAIN205' 
				WHERE a.assign_to = e.user_domain 
				<dynamic prepend="AND">
					<isNotNull property="searchKeyword">
						<isNotEmpty property="searchKeyword">
							<isEqual property="searchCategory" compareValue="taskCode">LOWER(a.task_code)
								LIKE LOWER ('%$searchKeyword$%')</isEqual>
							<isEqual property="searchCategory" compareValue="taskType">LOWER(a.assignment_category)
								LIKE LOWER ('%$searchKeyword$%')</isEqual>
							<isEqual property="searchCategory" compareValue="employee">
								(LOWER(e.first_name) LIKE LOWER ('%$searchKeyword$%') OR
								LOWER(e.last_name) LIKE LOWER ('%$searchKeyword$%'))
							</isEqual>
							<isEqual property="searchCategory" compareValue="status">LOWER(a.current_status)
								LIKE LOWER ('%$searchKeyword$%')</isEqual>
						</isNotEmpty>
					</isNotNull>
				</dynamic>
				<dynamic prepend="AND">
					<isNotNull property="startDate">
						<isNotNull property="endDate">
							<isNotEmpty property="startDate">
								<isNotEmpty property="endDate">
									assignment_due_date BETWEEN TO_DATE(#startDate#,'DD/MM/YYYY') AND TO_DATE(#endDate#,'DD/MM/YYYY')
								</isNotEmpty>
							</isNotEmpty>
						</isNotNull>
					</isNotNull>
				</dynamic>
				ORDER BY a.created_date DESC
			) a WHERE <![CDATA[ROWNUM <= #rowEnd#]]>
		)
		WHERE <![CDATA[seqnumb >= #rowStart#]]>
	</select>
	
	<select id="employeeReportEmployee" resultClass="adins.ace.taps.bean.assignment.EmployeeReportBean" parameterClass="java.util.Map">
		SELECT * FROM (
			SELECT ROWNUM seqnumb, a.* FROM (
				SELECT to_char(a.assignment_date,'DD-MM-YYYY, HH:MM') AS assignmentDate, 
					a.task_code AS assignmentCode,
					a.assignment_category AS assignmentCategory, 
					e.first_name || ' ' || e.last_name AS fullName,
					to_char(a.created_date,'DD-MM-YYYY, HH:MM') AS createdDate,
					to_char(a.assignment_due_date, 'DD-MM-YYYY') AS assignmentDueDate, 
					a.current_status AS currentStatus
				FROM assignments a 
				LEFT JOIN employees e
				ON LOWER(a.flag)='active' AND a.assign_to = 'domain3' 
				WHERE a.report_to = e.user_domain 
				<dynamic prepend="AND">
					<isNotNull property="searchKeyword">
						<isNotEmpty property="searchKeyword">
							<isEqual property="searchCategory" compareValue="taskCode">LOWER(a.task_code)
								LIKE LOWER ('%$searchKeyword$%')</isEqual>
							<isEqual property="searchCategory" compareValue="taskType">LOWER(a.assignment_category)
								LIKE LOWER ('%$searchKeyword$%')</isEqual>
							<isEqual property="searchCategory" compareValue="employee">
								(LOWER(e.first_name) LIKE LOWER ('%$searchKeyword$%') OR
								LOWER(e.last_name) LIKE LOWER ('%$searchKeyword$%'))
							</isEqual>
							<isEqual property="searchCategory" compareValue="status">LOWER(a.current_status)
								LIKE LOWER ('%$searchKeyword$%')</isEqual>
						</isNotEmpty>
					</isNotNull>
				</dynamic>
				<dynamic prepend="AND">
					<isNotNull property="startDate">
						<isNotNull property="endDate">
							<isNotEmpty property="startDate">
								<isNotEmpty property="endDate">
									assignment_due_date BETWEEN TO_DATE(#startDate#,'DD/MM/YYYY') AND TO_DATE(#endDate#,'DD/MM/YYYY')
								</isNotEmpty>
							</isNotEmpty>
						</isNotNull>
					</isNotNull>
				</dynamic>
				ORDER BY a.created_date DESC
			) a WHERE <![CDATA[ROWNUM <= #rowEnd#]]>
		)
		WHERE <![CDATA[seqnumb >= #rowStart#]]>
	</select>
	
	<select id="listAssignment" resultClass="adins.ace.taps.bean.assignment.EmployeeReportBean" parameterClass="java.util.Map">
		SELECT * FROM (
			SELECT ROWNUM seqnumb, a.* FROM (
				SELECT to_char(a.assignment_date,'DD-MM-YYYY, HH:MM') AS assignmentDate, 
					a.task_code AS assignmentCode,
					a.assignment_category AS assignmentCategory, 
					e.first_name || ' ' || e.last_name AS fullName,
					to_char(a.created_date,'DD-MM-YYYY, HH:MM') AS createdDate,
					to_char(a.assignment_due_date, 'DD-MM-YYYY') AS assignmentDueDate, 
					a.current_status AS currentStatus
				FROM assignments a 
				LEFT JOIN employees e
				ON LOWER(a.flag)='active' AND a.report_to = 'domain100' AND a.assignment_Category = 'ASSIGNMENT'
				WHERE a.assign_to = e.user_domain 
				<dynamic prepend="AND">
					<isNotNull property="searchKeyword">
						<isNotEmpty property="searchKeyword">
							<isEqual property="searchCategory" compareValue="taskCode">LOWER(a.task_code)
								LIKE LOWER ('%$searchKeyword$%')</isEqual>
							<isEqual property="searchCategory" compareValue="taskType">LOWER(a.assignment_category)
								LIKE LOWER ('%$searchKeyword$%')</isEqual>
							<isEqual property="searchCategory" compareValue="employee">
								(LOWER(e.first_name) LIKE LOWER ('%$searchKeyword$%') OR
								LOWER(e.last_name) LIKE LOWER ('%$searchKeyword$%'))
							</isEqual>
							<isEqual property="searchCategory" compareValue="status">LOWER(a.current_status)
								LIKE LOWER ('%$searchKeyword$%')</isEqual>
						</isNotEmpty>
					</isNotNull>
				</dynamic>
				<dynamic prepend="AND">
					<isNotNull property="startDate">
						<isNotNull property="endDate">
							<isNotEmpty property="startDate">
								<isNotEmpty property="endDate">
									assignment_due_date BETWEEN TO_DATE(#startDate#,'DD/MM/YYYY') AND TO_DATE(#endDate#,'DD/MM/YYYY')
								</isNotEmpty>
							</isNotEmpty>
						</isNotNull>
					</isNotNull>
				</dynamic>
				ORDER BY a.created_date DESC
			) a WHERE <![CDATA[ROWNUM <= #rowEnd#]]>
		)
		WHERE <![CDATA[seqnumb >= #rowStart#]]>
	</select>
	
<!-- insert current_status bergantung pada pilihan save(draft) dan assign(claim) -->
	<insert id="addAssignment" parameterClass="adins.ace.taps.bean.assignment.NewAssignmentBean">
		INSERT INTO assignments 
		(task_code, assignment_date, assignment_due_date, assignment_type, assignment_category, organization_code, project_code, description, 
		reff_task_code, activity_type, adhoc_user_domain, assign_to, report_to, flag, current_status, created_by, created_date) 
		VALUES
		(#taskCode#,#assignmentDate#, #assignmentDueDate#, #assignmentType#, 'ASSIGNMENT', #organizationCode#, #projectCode#, 
		#description#, #reffTaskCode#, 'ADHOC', #adhocUserDomain#, #assignTo#, #reportTo#, #flag#, #currentStatus#, 
		#createBy#, SYSDATE)
	</insert>

	<insert id="addSelfAssignment" parameterClass="adins.ace.taps.bean.assignment.NewAssignmentBean">
		INSERT INTO assignments 
		(task_code,assignment_date, assignment_due_date, assignment_type, assignment_category, organization_code, project_code, description, 
		reff_task_code, activity_type, adhoc_user_domain, assign_to, report_to, flag, current_status, created_by, created_date) 
		VALUES
		(#taskCode#,#assignmentDate#, #assignmentDueDate#, #assignmentType#, 'SELF ASSIGNMENT', #organizationCode#, #projectCode#, 
		#description#, #reffTaskCode#, #activityType#, #adhocUserDomain#, #assignTo#, #reportTo#, #flag#, #currentStatus#, 
		#createBy#, SYSDATE)
	</insert>
	
	<select id="searchOrganizationCode" resultClass="java.lang.String" parameterClass="java.lang.String">
		SELECT organization_code AS organizationCode
		FROM employees 
		WHERE user_domain = #userDomain#
	</select>
	
	<select id="searchHeadOrganizationCode" resultClass="adins.ace.taps.bean.assignment.NewAssignmentBean" parameterClass="java.lang.String">
		SELECT o.organization_name AS organizationName,
            mgr.first_name || ' ' || mgr.last_name AS headUserName
        FROM organizations o, employees mgr, employees e
        WHERE mgr.user_domain = o.head_user_domain
        AND o.organization_code = e.organization_code AND e.user_domain = #userDomain#
	</select>
	
	<select id="getMaxTaskCode" resultClass="java.lang.String" parameterClass="java.lang.String">
		SELECT LPAD(SUBSTR(MAX(task_code), 8, 11) + 1, 5, 0) FROM assignments
		WHERE task_code LIKE UPPER ('%$paramTaskCode$%')
	</select>
	
<!-- update current_status bergantung pada pilihan save(draft) dan assign(claim) -->	
<!-- 	<update id="editAssignment" parameterClass="adins.ace.bean.NewAssignmentBean"> -->
<!-- 		UPDATE assignments SET  -->
<!-- 			assignment_date = #assignmentDate#,  -->
<!-- 			assignment_due_date = #assignmentDueDate#,  -->
<!-- 			assignment_type = #assignmentType#,  -->
<!-- 			assignment_category = #assignmentCategory#,  -->
<!-- 			organization_code = #organizationCode#,  -->
<!-- 			project_code = #projectCode#,  -->
<!-- 			description = #description#,  -->
<!-- 			reff_task_code = #reffTaskCode#,  -->
<!-- 			activity_type = #activityType#,  -->
<!-- 			adhoc_user_domain = #adhocUserDomain#,  -->
<!-- 			assign_to = #assignTo#,  -->
<!-- 			report_to = #reportTo#,  -->
<!-- 			flag = 'INACTIVE',  -->
<!-- 			current_status = #currentStatus#,  -->
<!-- 			created_by = #createdBy#,  -->
<!-- 			created_date = SYSDATE -->
<!-- 	</update> -->
	
	<select id="searchRecordAssignment" resultClass="adins.ace.taps.bean.assignment.NewAssignmentBean" parameterClass="java.lang.String">
		SELECT a.task_code AS taskCode,
            a.assignment_date AS assignmentDate, 
            a.assignment_type AS assignmentType, 
            a.report_to AS reportTo, 
            o.organization_code AS organizationCode, 
            o.organization_name AS organizationName,
            mgr.first_name || ' ' || mgr.last_name AS headUserName,
            a.project_code AS projectCode, 
            a.reff_task_code AS reffTaskCode,
            a.activity_type AS activityType,
            a.adhoc_user_domain AS adhocUserDomain, 
            a.description AS description
        FROM assignments a, organizations o, employees e, employees mgr 
        WHERE a.task_code = #taskCode# AND a.assign_to = e.user_domain 
        AND e.organization_code = o.organization_code AND o.head_user_domain = mgr.user_domain
	</select>
	
	<select id="searchRecordClaimAssignment" resultClass="adins.ace.taps.bean.assignment.ClaimAssignmentBean" parameterClass="java.lang.String">
		SELECT a.task_code AS taskCode,
			a.assignment_due_date AS assignmentDueDate, 
            a.assignment_date AS assignmentDate, 
            a.assignment_type AS assignmentType,
            e.first_name || ' ' || e.last_name AS fullName,
            a.report_to AS reportTo,
            a.created_by AS createdBy, 
            o.organization_name AS organizationName,
            spv.first_name || ' ' || spv.last_name AS createdByName,
            p.project_name AS projectName, 
            a.reff_task_code AS reffTaskCode,
            a.activity_type AS activityType,
            a.description AS description
        FROM assignments a, organizations o, employees e, employees spv, projects p  
        WHERE a.task_code = #taskCode# AND a.assign_to = e.user_domain 
        AND e.organization_code = o.organization_code AND o.head_user_domain = spv.user_domain
        AND a.project_code = p.project_code(+)
	</select>
	
	<select id="searchDetailClaim" resultClass="adins.ace.taps.bean.assignment.ClaimAssignmentBean" parameterClass="java.lang.String">
		SELECT detail_id AS detailId,
			created_date AS claimDate,
			description AS detailDescription,
			manhour AS manHours
		FROM detail_assignment_claim
		WHERE task_code = #taskCode#
	</select>
	
	<select id="searchHistoryComment" resultClass="adins.ace.taps.bean.assignment.ClaimAssignmentBean" parameterClass="java.lang.String">
		SELECT history_id AS detailId,
			TO_CHAR(created_date,'DD-MM-YYYY') AS commentDate,
			comment AS assignmentComment,
			status AS status,
			e1.first_name || ' ' || e1.last_name AS commentFrom,
			e2.first_name || ' ' || e2.last_name AS commentTo
		FROM detail_assignment_claim d, employees e1, employees e2
		WHERE task_code = #taskCode# AND e1.user_domain = d.created_by 
		AND e2.user_domain = d.comment_to
	</select>
</sqlMap>