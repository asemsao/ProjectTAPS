<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="assignment">
	<select id="employeeReportSupervisor" resultClass="adins.ace.taps.bean.assignment.EmployeeReportBean" parameterClass="java.util.Map">
		SELECT * FROM (
			SELECT ROWNUM seqnumb, a.* FROM (
				SELECT to_char(a.assignment_date,'DD-MM-YYYY, HH24:MI') AS assignmentDate, 
					a.task_code AS assignmentCode,
					a.assignment_category AS assignmentCategory, 
					e.first_name || ' ' || e.last_name AS fullName,
					to_char(a.created_date,'DD-MM-YYYY, HH24:MI') AS createdDate,
					to_char(a.assignment_due_date, 'DD-MM-YYYY') AS assignmentDueDate, 
					a.current_status AS currentStatus
				FROM assignments a 
				LEFT JOIN employees e
				ON a.assign_to = e.user_domain 
				WHERE LOWER(a.flag)='active' AND a.report_to = 'DOMAIN205' 
				<dynamic prepend="AND">
					<isNotNull property="keyword">
						<isNotEmpty property="keyword">
							<isEqual property="category" compareValue="taskCode">LOWER(a.task_code)
								LIKE LOWER ('%$keyword$%')</isEqual>
							<isEqual property="category" compareValue="taskType">LOWER(a.assignment_category)
								LIKE LOWER ('%$keyword$%')</isEqual>
							<isEqual property="category" compareValue="employee">
								(LOWER(e.first_name) LIKE LOWER ('%$keyword$%') OR
								LOWER(e.last_name) LIKE LOWER ('%$keyword$%'))
							</isEqual>
							<isEqual property="category" compareValue="status">LOWER(a.current_status)
								LIKE LOWER ('%$keyword$%')</isEqual>
							<isEqual property="category" compareValue="All">(LOWER(a.task_code)
								LIKE LOWER ('%$keyword$%') OR LOWER(a.assignment_category)
								LIKE LOWER ('%$keyword$%') OR LOWER(e.first_name) 
								LIKE LOWER ('%$keyword$%') OR LOWER(e.last_name) 
								LIKE LOWER ('%$keyword$%') OR LOWER(a.current_status)
								LIKE LOWER ('%$keyword$%'))
							</isEqual>
						</isNotEmpty>
					</isNotNull>
				</dynamic>
				<dynamic prepend="AND">
					<isNotNull property="startDate">
						<isNotNull property="endDate">
							<isNotEmpty property="startDate">
								<isNotEmpty property="endDate">
									assignment_due_date BETWEEN TO_DATE(#startDate#,'DD/MM/YYYY') AND TO_DATE(#endDate#,'DD/MM/YYYY')
								</isNotEmpty>
							</isNotEmpty>
						</isNotNull>
					</isNotNull>
				</dynamic>
				ORDER BY a.created_date DESC
			) a WHERE <![CDATA[ROWNUM <= #end#]]>
		)
		WHERE <![CDATA[seqnumb >= #start#]]>
	</select>
	
	<select id="countEmployeeReportSupervisor" resultClass="int" parameterClass="java.util.Map">
		SELECT COUNT(1) FROM assignments a 
		LEFT JOIN employees e
		ON a.assign_to = e.user_domain 
		WHERE LOWER(a.flag)='active' AND a.report_to = 'DOMAIN205' 
		<dynamic prepend="AND">
			<isNotNull property="keyword">
				<isNotEmpty property="keyword">
					<isEqual property="category" compareValue="taskCode">LOWER(a.task_code)
						LIKE LOWER ('%$keyword$%')</isEqual>
					<isEqual property="category" compareValue="taskType">LOWER(a.assignment_category)
						LIKE LOWER ('%$keyword$%')</isEqual>
					<isEqual property="category" compareValue="employee">
						(LOWER(e.first_name) LIKE LOWER ('%$keyword$%') OR
						LOWER(e.last_name) LIKE LOWER ('%$keyword$%'))
					</isEqual>
					<isEqual property="category" compareValue="status">LOWER(a.current_status)
						LIKE LOWER ('%$keyword$%')
					</isEqual>
					<isEqual property="category" compareValue="All">(LOWER(a.task_code)
						LIKE LOWER ('%$keyword$%') OR LOWER(a.assignment_category)
						LIKE LOWER ('%$keyword$%') OR LOWER(e.first_name) 
						LIKE LOWER ('%$keyword$%') OR LOWER(e.last_name) 
						LIKE LOWER ('%$keyword$%') OR LOWER(a.current_status)
						LIKE LOWER ('%$keyword$%'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		<dynamic prepend="AND">
			<isNotNull property="startDate">
				<isNotNull property="endDate">
					<isNotEmpty property="startDate">
						<isNotEmpty property="endDate">
							assignment_due_date BETWEEN TO_DATE(#startDate#,'DD/MM/YYYY') AND TO_DATE(#endDate#,'DD/MM/YYYY')
						</isNotEmpty>
					</isNotEmpty>
				</isNotNull>
			</isNotNull>
		</dynamic>
	</select>
	
	<select id="employeeReportEmployee" resultClass="adins.ace.taps.bean.assignment.EmployeeReportBean" parameterClass="java.util.Map">
		SELECT * FROM (
			SELECT ROWNUM seqnumb, a.* FROM (
				SELECT to_char(a.assignment_date,'DD-MM-YYYY, HH24:MI') AS assignmentDate, 
					a.task_code AS assignmentCode,
					a.assignment_category AS assignmentCategory, 
					e.first_name || ' ' || e.last_name AS fullName,
					to_char(a.created_date,'DD-MM-YYYY, HH24:MI') AS createdDate,
					to_char(a.assignment_due_date, 'DD-MM-YYYY') AS assignmentDueDate, 
					a.current_status AS currentStatus
				FROM assignments a 
				LEFT JOIN employees e
				ON a.report_to = e.user_domain 
				WHERE LOWER(a.flag)='active' AND a.assign_to = 'domain3'  
				<dynamic prepend="AND">
					<isNotNull property="keyword">
						<isNotEmpty property="keyword">
							<isEqual property="category" compareValue="taskCode">LOWER(a.task_code)
								LIKE LOWER ('%$keyword$%')</isEqual>
							<isEqual property="category" compareValue="taskType">LOWER(a.assignment_category)
								LIKE LOWER ('%$keyword$%')</isEqual>
							<isEqual property="category" compareValue="employee">
								(LOWER(e.first_name) LIKE LOWER ('%$keyword$%') OR
								LOWER(e.last_name) LIKE LOWER ('%$keyword$%'))
							</isEqual>
							<isEqual property="category" compareValue="status">LOWER(a.current_status)
								LIKE LOWER ('%$keyword$%')
							</isEqual>
							<isEqual property="category" compareValue="All">(LOWER(a.task_code)
								LIKE LOWER ('%$keyword$%') OR LOWER(a.assignment_category)
								LIKE LOWER ('%$keyword$%') OR LOWER(e.first_name) 
								LIKE LOWER ('%$keyword$%') OR LOWER(e.last_name) 
								LIKE LOWER ('%$keyword$%') OR LOWER(a.current_status)
								LIKE LOWER ('%$keyword$%'))
							</isEqual>
						</isNotEmpty>
					</isNotNull>
				</dynamic>
				<dynamic prepend="AND">
					<isNotNull property="startDate">
						<isNotNull property="endDate">
							<isNotEmpty property="startDate">
								<isNotEmpty property="endDate">
									assignment_due_date BETWEEN TO_DATE(#startDate#,'DD/MM/YYYY') AND TO_DATE(#endDate#,'DD/MM/YYYY')
								</isNotEmpty>
							</isNotEmpty>
						</isNotNull>
					</isNotNull>
				</dynamic>
				ORDER BY a.created_date DESC
			) a WHERE <![CDATA[ROWNUM <= #end#]]>
		)
		WHERE <![CDATA[seqnumb >= #start#]]>
	</select>
	
	<select id="countEmployeeReportEmployee" resultClass="int" parameterClass="java.util.Map">
		SELECT COUNT(1) FROM assignments a 
		LEFT JOIN employees e
		ON a.report_to = e.user_domain 
		WHERE LOWER(a.flag)='active' AND a.assign_to = 'domain3' 
		<dynamic prepend="AND">
			<isNotNull property="keyword">
				<isNotEmpty property="keyword">
					<isEqual property="category" compareValue="taskCode">LOWER(a.task_code)
						LIKE LOWER ('%$keyword$%')</isEqual>
					<isEqual property="category" compareValue="taskType">LOWER(a.assignment_category)
						LIKE LOWER ('%$keyword$%')</isEqual>
					<isEqual property="category" compareValue="employee">
						(LOWER(e.first_name) LIKE LOWER ('%$keyword$%') OR
						LOWER(e.last_name) LIKE LOWER ('%$keyword$%'))
					</isEqual>
					<isEqual property="category" compareValue="status">LOWER(a.current_status)
						LIKE LOWER ('%$keyword$%')
					</isEqual>
					<isEqual property="category" compareValue="All">(LOWER(a.task_code)
						LIKE LOWER ('%$keyword$%') OR LOWER(a.assignment_category)
						LIKE LOWER ('%$keyword$%') OR LOWER(e.first_name) 
						LIKE LOWER ('%$keyword$%') OR LOWER(e.last_name) 
						LIKE LOWER ('%$keyword$%') OR LOWER(a.current_status)
						LIKE LOWER ('%$keyword$%'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		<dynamic prepend="AND">
			<isNotNull property="startDate">
				<isNotNull property="endDate">
					<isNotEmpty property="startDate">
						<isNotEmpty property="endDate">
							assignment_due_date BETWEEN TO_DATE(#startDate#,'DD/MM/YYYY') AND TO_DATE(#endDate#,'DD/MM/YYYY')
						</isNotEmpty>
					</isNotEmpty>
				</isNotNull>
			</isNotNull>
		</dynamic>
	</select>
	
	<select id="assignmentSupervisor" resultClass="adins.ace.taps.bean.assignment.EmployeeReportBean" parameterClass="java.util.Map">
		SELECT * FROM (
			SELECT ROWNUM seqnumb, a.* FROM (
				SELECT to_char(a.assignment_date,'DD-MM-YYYY, HH24:MI') AS assignmentDate, 
					a.task_code AS assignmentCode,
					a.assignment_category AS assignmentCategory, 
					e.first_name || ' ' || e.last_name AS fullName,
					to_char(a.created_date,'DD-MM-YYYY, HH24:MI') AS createdDate,
					to_char(a.assignment_due_date, 'DD-MM-YYYY') AS assignmentDueDate, 
					a.current_status AS currentStatus
				FROM assignments a 
				LEFT JOIN employees e
				ON a.assign_to = e.user_domain 
				WHERE LOWER(a.flag)='active' AND a.report_to = 'domain100' AND a.assignment_Category = 'ASSIGNMENT'
				<dynamic prepend="AND">
					<isNotNull property="keyword">
						<isNotEmpty property="keyword">
							<isEqual property="category" compareValue="taskCode">LOWER(a.task_code)
								LIKE LOWER ('%$keyword$%')</isEqual>
							<isEqual property="category" compareValue="taskType">LOWER(a.assignment_category)
								LIKE LOWER ('%$keyword$%')</isEqual>
							<isEqual property="category" compareValue="employee">
								(LOWER(e.first_name) LIKE LOWER ('%$keyword$%') OR
								LOWER(e.last_name) LIKE LOWER ('%$keyword$%'))
							</isEqual>
							<isEqual property="category" compareValue="status">LOWER(a.current_status)
								LIKE LOWER ('%$keyword$%')</isEqual>
							<isEqual property="category" compareValue="All">(LOWER(a.task_code)
								LIKE LOWER ('%$keyword$%') OR LOWER(a.assignment_category)
								LIKE LOWER ('%$keyword$%') OR LOWER(e.first_name) 
								LIKE LOWER ('%$keyword$%') OR LOWER(e.last_name) 
								LIKE LOWER ('%$keyword$%') OR LOWER(a.current_status)
								LIKE LOWER ('%$keyword$%'))
							</isEqual>
						</isNotEmpty>
					</isNotNull>
				</dynamic>
				<dynamic prepend="AND">
					<isNotNull property="startDate">
						<isNotNull property="endDate">
							<isNotEmpty property="startDate">
								<isNotEmpty property="endDate">
									assignment_due_date BETWEEN TO_DATE(#startDate#,'DD/MM/YYYY') AND TO_DATE(#endDate#,'DD/MM/YYYY')
								</isNotEmpty>
							</isNotEmpty>
						</isNotNull>
					</isNotNull>
				</dynamic>
				ORDER BY a.created_date DESC
			) a WHERE <![CDATA[ROWNUM <= #end#]]>
		)
		WHERE <![CDATA[seqnumb >= #start#]]>
	</select>
	
	<select id="countAssignmentSupervisor" resultClass="int" parameterClass="java.util.Map">
		SELECT COUNT(1) FROM assignments a 
		LEFT JOIN employees e
		ON a.assign_to = e.user_domain 
		WHERE LOWER(a.flag)='active' AND a.report_to = 'domain100' AND a.assignment_Category = 'ASSIGNMENT'
		<dynamic prepend="AND">
			<isNotNull property="keyword">
				<isNotEmpty property="keyword">
					<isEqual property="category" compareValue="taskCode">LOWER(a.task_code)
						LIKE LOWER ('%$keyword$%')</isEqual>
					<isEqual property="category" compareValue="taskType">LOWER(a.assignment_category)
						LIKE LOWER ('%$keyword$%')</isEqual>
					<isEqual property="category" compareValue="employee">
						(LOWER(e.first_name) LIKE LOWER ('%$keyword$%') OR
						LOWER(e.last_name) LIKE LOWER ('%$keyword$%'))
					</isEqual>
					<isEqual property="category" compareValue="status">LOWER(a.current_status)
						LIKE LOWER ('%$keyword$%')
					</isEqual>
					<isEqual property="category" compareValue="All">(LOWER(a.task_code)
						LIKE LOWER ('%$keyword$%') OR LOWER(a.assignment_category)
						LIKE LOWER ('%$keyword$%') OR LOWER(e.first_name) 
						LIKE LOWER ('%$keyword$%') OR LOWER(e.last_name) 
						LIKE LOWER ('%$keyword$%') OR LOWER(a.current_status)
						LIKE LOWER ('%$keyword$%'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		<dynamic prepend="AND">
			<isNotNull property="startDate">
				<isNotNull property="endDate">
					<isNotEmpty property="startDate">
						<isNotEmpty property="endDate">
							assignment_due_date BETWEEN TO_DATE(#startDate#,'DD/MM/YYYY') AND TO_DATE(#endDate#,'DD/MM/YYYY')
						</isNotEmpty>
					</isNotEmpty>
				</isNotNull>
			</isNotNull>
		</dynamic>
	</select>
	
<!-- insert current_status bergantung pada pilihan save(draft) dan assign(claim) -->
	<insert id="addAssignment" parameterClass="adins.ace.taps.bean.assignment.NewAssignmentBean">
		INSERT INTO assignments 
		(task_code, assignment_date, assignment_due_date, assignment_type, assignment_category, organization_code, project_code, description, 
		reff_task_code, activity_type, adhoc_user_domain, assign_to, report_to, flag, current_status, created_by, created_date) 
		VALUES
		(#taskCode#,#assignmentDate#, #assignmentDueDate#, #assignmentType#, 'ASSIGNMENT', #organizationCode#, #projectCode#, 
		#description#, #reffTaskCode#, 'ADHOC', #adhocUserDomain#, #assignTo#, #reportTo#, #flag#, #currentStatus#, 
		#createdBy#, SYSDATE)
	</insert>

	<insert id="addSelfAssignment" parameterClass="adins.ace.taps.bean.assignment.NewAssignmentBean">
		INSERT INTO assignments 
		(task_code,assignment_date, assignment_due_date, assignment_type, assignment_category, organization_code, project_code, description, 
		reff_task_code, activity_type, adhoc_user_domain, assign_to, report_to, flag, current_status, created_by, created_date) 
		VALUES
		(#taskCode#,#assignmentDate#, #assignmentDueDate#, #assignmentType#, 'SELF ASSIGNMENT', #organizationCode#, #projectCode#, 
		#description#, #reffTaskCode#, #activityType#, #adhocUserDomain#, #assignTo#, #reportTo#, #flag#, #currentStatus#, 
		#createdBy#, SYSDATE)
	</insert>
	
	<select id="searchOrganizationCode" resultClass="java.lang.String" parameterClass="java.lang.String">
		SELECT organization_code AS organizationCode
		FROM employees 
		WHERE user_domain = #userDomain#
	</select>
	
	<select id="searchHeadOrganizationCode" resultClass="adins.ace.taps.bean.assignment.NewAssignmentBean" parameterClass="java.lang.String">
		SELECT o.organization_name AS organizationName,
            mgr.first_name || ' ' || mgr.last_name AS headUserName
        FROM organizations o, employees mgr, employees e
        WHERE mgr.user_domain = o.head_user_domain
        AND o.organization_code = e.organization_code AND e.user_domain = #userDomain#
	</select>
	
	<select id="getMaxTaskCode" resultClass="java.lang.String" parameterClass="java.lang.String">
		SELECT LPAD(SUBSTR(MAX(task_code), 8, 11) + 1, 5, 0) FROM assignments
		WHERE task_code LIKE UPPER ('%$paramTaskCode$%')
	</select>
	
<!-- update current_status bergantung pada pilihan save(draft) dan assign(claim) -->	
	<update id="editAssignment" parameterClass="adins.ace.taps.bean.assignment.NewAssignmentBean">
		UPDATE assignments SET 
			assignment_date = #assignmentDate#, 
			assignment_due_date = #assignmentDueDate#, 
			assignment_type = #assignmentType#, 
			organization_code = #organizationCode#, 
			project_code = #projectCode#, 
			description = #description#, 
			reff_task_code = #reffTaskCode#, 
			assign_to = #assignTo#, 
			flag = #flag#, 
			current_status = #currentStatus#, 
			updated_by = #updatedBy#, 
			updated_date = SYSDATE
		WHERE task_code = #taskCode#
	</update>
	
	<update id="editSelfAssignment" parameterClass="adins.ace.taps.bean.assignment.NewAssignmentBean">
		UPDATE assignments SET 
			assignment_date = #assignmentDate#, 
			assignment_due_date = #assignmentDueDate#, 
			assignment_type = #assignmentType#, 
			organization_code = #organizationCode#, 
			report_to = #reportTo#,
			activity_type = #activityType#,
			adhoc_user_domain = #adhocUserDomain#,
			project_code = #projectCode#, 
			description = #description#, 
			reff_task_code = #reffTaskCode#, 
			flag = #flag#, 
			current_status = #currentStatus#, 
			updated_by = #updatedBy#, 
			updated_date = SYSDATE
		WHERE task_code = #taskCode#
	</update>
	
	<select id="searchRecordAssignment" resultClass="adins.ace.taps.bean.assignment.NewAssignmentBean" parameterClass="java.lang.String">
		SELECT a.task_code AS taskCode,
            TO_CHAR(a.assignment_date,'DD/MM/YYYY') AS assignmentDate, 
            TO_CHAR(a.assignment_due_date,'DD/MM/YYYY') AS assignmentDueDate, 
            a.assignment_type AS assignmentType, 
            a.assign_to AS assignTo,
            e.first_name || ' ' || e.last_name AS assignToFullName,
            a.report_to AS reportTo, 
            o.organization_code AS organizationCode, 
            o.organization_name AS organizationName,
            mgr.first_name || ' ' || mgr.last_name AS headUserName,
            a.project_code AS projectCode, 
            a.reff_task_code AS reffTaskCode,
            a.activity_type AS activityType,
            a.adhoc_user_domain AS adhocUserDomain, 
            a.description AS description
        FROM assignments a, organizations o, employees e, employees mgr
        WHERE a.task_code = #taskCode# AND a.assign_to = e.user_domain 
        AND e.organization_code = o.organization_code AND o.head_user_domain = mgr.user_domain 
	</select>
	
	<select id="searchRecordSelfAssignment" resultClass="adins.ace.taps.bean.assignment.NewAssignmentBean" parameterClass="java.lang.String">
		SELECT a.task_code AS taskCode,
            TO_CHAR(a.assignment_date,'DD/MM/YYYY') AS assignmentDate, 
            TO_CHAR(a.assignment_due_date,'DD/MM/YYYY') AS assignmentDueDate, 
            a.assignment_type AS assignmentType, 
            a.assign_to AS assignTo,
            e.first_name || ' ' || e.last_name AS assignToFullName,
            a.report_to AS reportTo, 
            o.organization_code AS organizationCode, 
            o.organization_name AS organizationName,
            mgr.first_name || ' ' || mgr.last_name AS headUserName,
            a.project_code AS projectCode, 
            a.reff_task_code AS reffTaskCode,
            a.activity_type AS activityType,
            a.adhoc_user_domain AS adhocUserDomain, 
            a.description AS description,
            d.manhour AS manHours
        FROM assignments a, organizations o, employees e, employees mgr, detail_claim_assignments d
        WHERE a.task_code = #taskCode# AND a.assign_to = e.user_domain 
        AND e.organization_code = o.organization_code AND o.head_user_domain = mgr.user_domain 
        AND a.task_code = d.task_code
	</select>
	
	<select id="searchRecordClaimAssignment" resultClass="adins.ace.taps.bean.assignment.ClaimAssignmentBean" parameterClass="java.lang.String">
		SELECT a.task_code AS taskCode,
			TO_CHAR(a.assignment_due_date,'DD/MM/YYYY') AS assignmentDueDate, 
            TO_CHAR(a.assignment_date,'DD/MM/YYYY, HH24:MI') AS assignmentDate, 
            a.assignment_type AS assignmentType,
            e.first_name || ' ' || e.last_name AS fullName,
            a.report_to AS reportTo,
            a.created_by AS createdBy, 
            o.organization_name AS organizationName,
            spv.first_name || ' ' || spv.last_name AS createdByName,
            p.project_name AS projectName, 
            a.reff_task_code AS reffTaskCode,
            a.activity_type AS activityType,
            a.description AS description
        FROM assignments a, organizations o, employees e, employees spv, projects p  
        WHERE a.task_code = #taskCode# AND a.assign_to = e.user_domain 
        AND e.organization_code = o.organization_code AND o.head_user_domain = spv.user_domain
        AND a.project_code = p.project_code(+)
	</select>
	
	<select id="searchDetailClaim" resultClass="adins.ace.taps.bean.assignment.ClaimAssignmentBean" parameterClass="java.lang.String">
		SELECT detail_id AS detailId,
			TO_CHAR(created_date,'DD/MM/YYYY') AS claimDate,
			description AS detailDescription,
			manhour AS manHours
		FROM detail_claim_assignments
		WHERE task_code = #taskCode#
		ORDER BY detail_id
	</select>

	<select id="searchHistoryComment" resultClass="adins.ace.taps.bean.assignment.ClaimAssignmentBean" parameterClass="java.lang.String">
		SELECT history_id AS historyId,
            TO_CHAR(c.created_date,'DD-MM-YYYY') AS commentDate,
            c.comments AS assignmentComment,
            c.status AS status,
            e1.first_name || ' ' || e1.last_name AS commentFrom,
            e2.first_name || ' ' || e2.last_name AS commentTo
        FROM assignment_comments c, employees e1, employees e2
        WHERE task_code = #taskCode# AND e1.user_domain = c.created_by 
        AND e2.user_domain = c.comment_to;
	</select>
	
	<insert id="addDetailClaim" parameterClass="adins.ace.taps.bean.assignment.NewAssignmentBean">
		INSERT INTO detail_claim_assignments (detail_id,task_code,manhour,description,created_by,created_date) 
		VALUES (SEQUENCE_CLAIMS.NEXTVAL,#taskCode#,#manHours#,#description#,#createdBy#,SYSDATE)
	</insert>
	
	<update id="editClaimSelfAssignment" parameterClass="adins.ace.taps.bean.assignment.NewAssignmentBean">
		UPDATE detail_claim_assignments SET
			manhour = #manHours#,
			description = #description#,
			updated_by = #updatedBy#,
			updated_date = SYSDATE
		WHERE task_code = #taskCode#
	</update>
</sqlMap>
