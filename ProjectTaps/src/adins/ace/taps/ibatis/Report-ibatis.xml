<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="report">

	<select id="getAllReports" resultClass="adins.ace.taps.bean.report.ReportBean">
		select task_code as
		reportId, organization_code as firstName, project_code as lastName
		from reports
	</select>
	
	<select id="getReportLevelDepartment" resultClass="adins.ace.taps.bean.report.ReportBean">
	select e.first_name||' '||e.last_name as employeeName, NVL(round(count(1)/sum(r.manhour),3),0)  as productivity, NVL(sum(r.star),0) as quality from reports r, employees e
	where r.assign_to = e.user_domain and e.organization_code = #orgCode# and lower(e.flag)='active'
	group by e.first_name||' '||e.last_name
	</select>
	
	<select id="getReportLevelDivision" resultClass="adins.ace.taps.bean.report.ReportBean">
	select e.organization_code as organizationCode, e.first_name||' '||e.last_name as employeeName, NVL(round(count(1)/sum(r.manhour),3),0)  as productivity, NVL(sum(r.star),0) as quality from reports r, employees e
	where r.assign_to = e.user_domain and lower(e.flag)='active' and e.organization_code in (select o.organization_code from organizations o where o.parent_organization_code = #orgCode#)
	group by e.first_name||' '||e.last_name, e.organization_code
	</select>
	
	<select id="getReportLevelManagement" resultClass="adins.ace.taps.bean.report.ReportBean">
	select e.organization_code as organizationCode, e.first_name||' '||e.last_name as employeeName, NVL(round(count(1)/sum(r.manhour),3),0)  as productivity, NVL(sum(r.star),0) as quality from reports r, employees e
	where r.assign_to(+) = e.user_domain and lower(e.flag)='active' and e.organization_code in (SELECT o.organization_code
                                                                                            	FROM organizations o 
                                                                                            	WHERE LOWER(o.flag) = 'active' and o.organization_code != #orgCode#
                                                                                            	START WITH o.organization_code = #orgCode#
                                                                                            	CONNECT BY PRIOR UPPER(o.organization_code) = UPPER(o.parent_organization_code))
	group by e.first_name||' '||e.last_name, e.organization_code
	</select>	

	<select id="getReportLevel1" resultClass="adins.ace.taps.bean.report.ReportBean"
		parameterClass="java.util.Map">
		SELECT LPAD (
		o.organization_code,
		LENGTH (o.organization_code)
		+ (LEVEL
		* 2)
		- 2,
		' '
		)
		AS organizationCode,
		o.organization_name AS
		organizationName,
		o.organization_level AS organizationLevel,
		o.parent_organization_code AS organizationParent,
		NVL((SELECT SUM
		(R.MANHOUR)
		FROM REPORTS R
		WHERE (R.ORGANIZATION_CODE =
		O.ORGANIZATION_CODE)
		AND (TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'YYYY')
		LIKE '%$reportYear$%')
		<dynamic prepend="AND">
			<isNotNull property="reportPeriode">
				<isNotEmpty property="reportPeriode">
					<isEqual property="reportPeriode" compareValue="I">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('01','02','03','04','05','06'))
					</isEqual>
					<isEqual property="reportPeriode" compareValue="II">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('07','08','09','10','11','12'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
		</dynamic>

		<dynamic prepend="AND">
			<isNotNull property="reportMonth">
				<isNotEmpty property="reportMonth">
					(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') LIKE '%$reportMonth$%')
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		),0) AS manhourBU,
		NVL (
		(SELECT SUM (R.MANHOUR)
		FROM REPORTS R
		WHERE
		(R.PROJECT_CODE IN
		(SELECT P.PROJECT_CODE
		FROM PROJECTS P
		WHERE
		P.ORGANIZATION_CODE =
		O.ORGANIZATION_CODE))
		
		AND (TO_CHAR (R.ASSIGNMENT_APPROVED_DATE, 'YYYY') LIKE
		'%$reportYear$%')
		<dynamic prepend="AND">
			<isNotNull property="reportPeriode">
				<isNotEmpty property="reportPeriode">
					<isEqual property="reportPeriode" compareValue="I">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('01','02','03','04','05','06'))
					</isEqual>
					<isEqual property="reportPeriode" compareValue="II">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('07','08','09','10','11','12'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
		</dynamic>

		<dynamic prepend="AND">
			<isNotNull property="reportMonth">
				<isNotEmpty property="reportMonth">
					(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') LIKE '%$reportMonth$%')
				</isNotEmpty>
			</isNotNull>
		</dynamic>

		),0)
		AS manhourProject
		FROM organizations o
		LEFT JOIN
		employees e
		ON
		o.head_user_domain = e.user_domain
		LEFT JOIN
		organizations r
		ON
		o.parent_organization_code =
		r.organization_code
		WHERE LOWER (o.flag) =
		'active'
		AND O.ORGANIZATION_LEVEL != #orgLevel#
		START WITH
		o.organization_code = #orgCode#
		CONNECT BY PRIOR o.organization_code =
		o.parent_organization_code
	</select>

	<select id="getReportLevel2" resultClass="adins.ace.taps.bean.report.ReportBean"
		parameterClass="java.util.Map">
		select e.first_name||' '||e.last_name as employeeName,
		NVL((select
		sum(r.manhour) from reports r where
		lower(r.assignment_category)='self
		assignment' and
		r.assign_to=e.user_domain
		<dynamic prepend="AND">
			<isNotNull property="reportPeriode">
				<isNotEmpty property="reportPeriode">
					<isEqual property="reportPeriode" compareValue="I">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('01','02','03','04','05','06'))
					</isEqual>
					<isEqual property="reportPeriode" compareValue="II">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('07','08','09','10','11','12'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="reportMonth">
				<isNotEmpty property="reportMonth">
					(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') LIKE '%$reportMonth$%')
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		),0) as totalSelfAssignment,
		NVL((select sum(r.manhour) from reports r
		where
		lower(r.assignment_category)='assignment' and
		r.assign_to=e.user_domain
		<dynamic prepend="AND">
			<isNotNull property="reportPeriode">
				<isNotEmpty property="reportPeriode">
					<isEqual property="reportPeriode" compareValue="I">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('01','02','03','04','05','06'))
					</isEqual>
					<isEqual property="reportPeriode" compareValue="II">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('07','08','09','10','11','12'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="reportMonth">
				<isNotEmpty property="reportMonth">
					(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') LIKE '%$reportMonth$%')
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		),0) as totalAssignment,
		NVL((select sum(r.manhour) from reports r
		where r.assign_to=e.user_domain
		and lower(r.assignment_type) = 'bu'
		<dynamic prepend="AND">
			<isNotNull property="reportPeriode">
				<isNotEmpty property="reportPeriode">
					<isEqual property="reportPeriode" compareValue="I">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('01','02','03','04','05','06'))
					</isEqual>
					<isEqual property="reportPeriode" compareValue="II">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('07','08','09','10','11','12'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="reportMonth">
				<isNotEmpty property="reportMonth">
					(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') LIKE '%$reportMonth$%')
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		),0) as totalBU,
		NVL((select sum(r.manhour) from reports r where
		r.assign_to=e.user_domain
		and lower(r.assignment_type) = 'project'
		<dynamic prepend="AND">
			<isNotNull property="reportPeriode">
				<isNotEmpty property="reportPeriode">
					<isEqual property="reportPeriode" compareValue="I">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('01','02','03','04','05','06'))
					</isEqual>
					<isEqual property="reportPeriode" compareValue="II">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('07','08','09','10','11','12'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
			<isNotNull property="reportMonth">
				<isNotEmpty property="reportMonth">
					(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') LIKE '%$reportMonth$%')
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		),0) as totalProject
		from employees e
		where
		e.organization_code=#orgCode#

	</select>

	<select id="getReportLevel2_v2" resultClass="adins.ace.taps.bean.report.ReportBean"
		parameterClass="java.util.Map">
		select e.first_name||' '||e.last_name as employeeName,
		NVL((select
		sum(r.manhour) from reports r where
		(lower(r.assignment_category)='self assignment' and
		r.assign_to=e.user_domain
		and lower(r.assignment_type) = 'bu')
		<dynamic prepend="AND">
			<isNotNull property="reportPeriode">
				<isNotEmpty property="reportPeriode">
					<isEqual property="reportPeriode" compareValue="I">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('01','02','03','04','05','06'))
					</isEqual>
					<isEqual property="reportPeriode" compareValue="II">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('07','08','09','10','11','12'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		<dynamic prepend="AND">
			<isNotNull property="reportMonth">
				<isNotEmpty property="reportMonth">
					(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') LIKE '%$reportMonth$%')
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		),0) as totalSelfAssignmentBU,
		NVL((select sum(r.manhour) from reports
		r where
		(lower(r.assignment_category)='assignment' and
		r.assign_to=e.user_domain
		and lower(r.assignment_type) = 'bu')
		<dynamic prepend="AND">
			<isNotNull property="reportPeriode">
				<isNotEmpty property="reportPeriode">
					<isEqual property="reportPeriode" compareValue="I">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('01','02','03','04','05','06'))
					</isEqual>
					<isEqual property="reportPeriode" compareValue="II">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('07','08','09','10','11','12'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		<dynamic prepend="AND">
			<isNotNull property="reportMonth">
				<isNotEmpty property="reportMonth">
					(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') LIKE '%$reportMonth$%')
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		),0) as totalAssignmentBU,
		NVL((select sum(r.manhour) from reports r
		where
		(lower(r.assignment_category)='self assignment' and
		r.assign_to=e.user_domain
		and lower(r.assignment_type) = 'project')
		<dynamic prepend="AND">
			<isNotNull property="reportPeriode">
				<isNotEmpty property="reportPeriode">
					<isEqual property="reportPeriode" compareValue="I">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('01','02','03','04','05','06'))
					</isEqual>
					<isEqual property="reportPeriode" compareValue="II">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('07','08','09','10','11','12'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		<dynamic prepend="AND">
			<isNotNull property="reportMonth">
				<isNotEmpty property="reportMonth">
					(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') LIKE '%$reportMonth$%')
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		),0) as totalSelfAssignmentProject,
		NVL((select sum(r.manhour) from
		reports r where (lower(r.assignment_category)='assignment' and
		r.assign_to=e.user_domain
		and lower(r.assignment_type) = 'project')
		<dynamic prepend="AND">
			<isNotNull property="reportPeriode">
				<isNotEmpty property="reportPeriode">
					<isEqual property="reportPeriode" compareValue="I">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('01','02','03','04','05','06'))
					</isEqual>
					<isEqual property="reportPeriode" compareValue="II">
						(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') IN
						('07','08','09','10','11','12'))
					</isEqual>
				</isNotEmpty>
			</isNotNull>

		</dynamic>
		<dynamic prepend="AND">
			<isNotNull property="reportMonth">
				<isNotEmpty property="reportMonth">
					(TO_CHAR(R.ASSIGNMENT_APPROVED_DATE,'MM') LIKE '%$reportMonth$%')
				</isNotEmpty>
			</isNotNull>
		</dynamic>
		),0) as totalAssignmentProject
		from employees e
		where
		e.organization_code=#orgCode#

	</select>

	<select id="getHeadOrganization" resultClass="adins.ace.taps.bean.report.ReportBean"
		parameterClass="java.util.Map">
		select o.parent_organization_code as
		organizationParent, org.organization_name as organizationParentName
		from organizations o, organizations org
		where
		o.organization_code=#orgCode# and
		org.organization_code=o.parent_organization_code
	</select>

	<select id="getStartDate" resultClass="java.lang.String"
		parameterClass="java.util.Map">
		select transfer_date as startDate from history_projects
		where project_code = #prjCode#
		and organization_after = #orgCode#
	</select>

	<select id="getEndDate" resultClass="java.lang.String"
		parameterClass="java.util.Map">
		select transfer_date as endDate from history_projects
		where project_code = #prjCode#
		and organization_before = #orgCode#
	</select>

	<select id="countHistoryProjects" resultClass="int"
		parameterClass="java.util.Map">
		select count(1) from history_projects
		where project_code
		= #prjCode#
		and organization_before = #orgCode#
	</select>
</sqlMap>